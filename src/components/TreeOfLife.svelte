<script lang="ts">
	let { card } = $props();
	let canvasWidth: number = 50;
	let canvasHeight: number = 80;
	let nodeSize: number = 4;
	let color: string = "currentColor";
	let strokeWidth: number = 1;
	let showLabels: boolean = false;

	let sephira: Record<string, number[]> = {
		Kether: [canvasWidth * 0.5, canvasHeight * 0.1],
		Binah: [canvasWidth * 0.2, canvasHeight * 0.2],
		Chokmah: [canvasWidth * 0.8, canvasHeight * 0.2],
		Geburah: [canvasWidth * 0.2, canvasHeight * 0.4],
		Hod: [canvasWidth * 0.2, canvasHeight * 0.6],
		Tiphareth: [canvasWidth * 0.5, canvasHeight * 0.5],
		Netzach: [canvasWidth * 0.8, canvasHeight * 0.6],
		Chesed: [canvasWidth * 0.8, canvasHeight * 0.4],
		Yesod: [canvasWidth * 0.5, canvasHeight * 0.7],
		Malkuth: [canvasWidth * 0.5, canvasHeight * 0.87],
	};

	const links = [
		["Kether", "Binah"],
		["Kether", "Chokmah"],
		["Kether", "Tiphareth"],
		["Binah", "Chokmah"],
		["Binah", "Geburah"],
		["Binah", "Tiphareth"],
		["Chokmah", "Tiphareth"],
		["Chokmah", "Chesed"],
		["Geburah", "Chesed"],
		["Geburah", "Tiphareth"],
		["Geburah", "Hod"],
		["Chesed", "Tiphareth"],
		["Chesed", "Netzach"],
		["Tiphareth", "Hod"],
		["Tiphareth", "Netzach"],
		["Tiphareth", "Yesod"],
		["Hod", "Netzach"],
		["Hod", "Yesod"],
		["Hod", "Malkuth"],
		["Netzach", "Yesod"],
		["Netzach", "Malkuth"],
		["Yesod", "Malkuth"],
	];

	let cardSefira = $state(card?.tree_of_life_sefira);
	let cardPath = $state(card?.tree_of_life_path);

	$effect(() => {
		cardSefira = card?.tree_of_life_sefira?.name;
		cardPath = card?.tree_of_life_path;
	});

	function getElementFilter(element: string) {
		const filter =
			cardSefira && cardSefira !== "NA" && cardSefira === element;
		return filter;
	}

	function isActivePath(sefirot: string[]) {
		if (!cardPath || !cardPath.sefirot || cardPath.sefirot.length !== 2) {
			return false;
		}
		const [pathStart, pathEnd] = cardPath.sefirot.map((s: string) =>
			s.trim(),
		);
		const [linkStart, linkEnd] = sefirot.map((s) => s.trim());
		const isActive =
			(linkStart === pathStart && linkEnd === pathEnd) ||
			(linkStart === pathEnd && linkEnd === pathStart);
		return isActive;
	}
</script>

<svg
	xmlns="http://www.w3.org/2000/svg"
	width={canvasWidth}
	height={canvasHeight}
	viewBox="0 0 {canvasWidth} {canvasHeight}"
	aria-label="Tree of Life"
	role="img"
>
	<defs>
		<style>
			.node {
				fill: white;
				text-anchor: middle;
				transition: all 0.3s ease;
			}
			.link {
				fill: none;
				transition:
					opacity 0.3s ease,
					stroke-width 0.3s ease;
			}
			.label {
				font: 10px;
				text-anchor: middle;
				transition: opacity 0.3s ease;
			}
		</style>
		<filter
			id="sofGlow"
			filterUnits="userSpaceOnUse"
			x="-50%"
			y="-50%"
			width="200%"
			height="200%"
		>
			<feMorphology
				operator="dilate"
				radius="1"
				in="SourceAlpha"
				result="thicken"
			/>
			<feGaussianBlur in="thicken" stdDeviation="3" result="blurred" />
			<feFlood flood-color="rgb(255, 204, 0)" result="glowColor" />
			<feComposite
				in="glowColor"
				in2="blurred"
				operator="in"
				result="softGlow_colored"
			/>
			<feMerge>
				<feMergeNode in="softGlow_colored" />
				<feMergeNode in="SourceGraphic" />
			</feMerge>
		</filter>
	</defs>

	{#each links as [a, b]}
		{@const pathIsActive = isActivePath([a, b])}
		<line
			opacity={pathIsActive ? 1 : 0.5}
			filter={pathIsActive ? "url(#sofGlow)" : ""}
			class="link"
			stroke={color}
			stroke-width={pathIsActive ? strokeWidth * 2 : strokeWidth}
			x1={sephira[a][0]}
			y1={sephira[a][1]}
			x2={sephira[b][0]}
			y2={sephira[b][1]}
		/>
	{/each}

	{#each Object.keys(sephira) as label}
		<g opacity={cardSefira && cardSefira === label ? 1 : 0.5}>
			<circle
				class="node"
				stroke={color}
				stroke-width={strokeWidth}
				cx={sephira[label][0]}
				cy={sephira[label][1]}
				r={nodeSize}
				filter={getElementFilter(label) ? "url(#sofGlow)" : ""}
			/>
			{#if showLabels}
				<text
					class="label"
					fill={color}
					x={sephira[label][0]}
					y={sephira[label][1] + 30}>{label ?? ""}</text
				>
			{/if}
		</g>
	{/each}
</svg>
